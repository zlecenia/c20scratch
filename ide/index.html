<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext y='14' font-size='14'%3E🧩%3C/text%3E%3C/svg%3E" />
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <!-- CodeMirror 5 for source editor -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.css"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
    <!-- ES Module bridge that imports API module generators and exposes them globally -->
    <script src="./js/utils.js"></script>
    <script src="./js/modules/manager.js"></script>
    <script src="./js/preview.js"></script>
    <script type="module" src="./js/main-modules.js"></script>
</head>
<body>
<h2>IDE z OpenAPI → automatyczne bloki</h2>
<div id="controls" style="margin: 8px 0;">
  <button id="runBtn">Run Preview</button>
  <label style="margin-left:12px;">
    <input type="checkbox" id="autoRunToggle" /> Auto-run on changes
  </label>
  <span id="autoRunStatus" style="margin-left:8px;color:#666;"></span>
  <!-- The controls trigger runCode() and an optional debounced auto-run -->
  <!-- Manual test UI inside the preview remains available for generator diagnostics -->

  <input id="projectName" placeholder="project name" style="margin-left:12px;" />
  <button id="saveProjectBtn">Save Project</button>
  <select id="projectList" style="margin-left:6px;"></select>
  <button id="loadProjectBtn">Load</button>
  <span style="margin:0 8px;">|</span>
  <label>Demo:</label>
  <select id="demoList" style="margin-left:6px; min-width:140px"></select>
  <button id="loadDemoBtn">Load Demo</button>
  <button id="refreshProjectsBtn">Refresh</button>
  <span id="projectStatus" style="margin-left:8px;color:#666;"></span>
  <span style="margin:0 8px;">|</span>
  <button id="saveHtmlBtn">Save HTML</button>
  <button id="openHtmlBtn">Open HTML</button>
  <span style="margin:0 8px;">|</span>
  <input id="uploadInput" type="file" accept=".xml,.svg" />
  <button id="uploadBtn">Upload</button>
  <select id="uploadsList" style="margin-left:6px; min-width:140px"></select>
  <button id="openUploadBtn">Open File</button>
  <span style="margin:0 8px;">|</span>
  <label>
    <input type="checkbox" id="autosaveToggle" checked /> Autosave
  </label>
  <span id="autosaveStatus" style="margin-left:8px;color:#666;"></span>
  <button id="loadXmlToWorkspaceBtn">Load XML to Workspace</button>
  <span style="margin:0 8px;">|</span>
  <label>OpenAPI URL:</label>
  <input id="openapiUrl" style="min-width:280px" value="https://petstore.swagger.io/v2/swagger.json" />
  <button id="reloadApiBtn" title="Reload API blocks from OpenAPI">Reload API</button>
  <span style="margin:0 8px;">|</span>
  <button id="moduleManagerBtn" title="Manage Modules & Packages">📦 Modules</button>
  <input id="moduleUpload" type="file" accept=".xml" style="display:none" />
  <button id="uploadModuleBtn" title="Upload Module Package">Upload Module</button>
</div>
<div id="mainSplit" style="display:flex; gap:8px; align-items:stretch;">
  <div id="blockCol" style="flex:1; min-width:0;">
    <div id="blocklyDiv" style="height: 500px; width: 100%;"></div>
  </div>
  <iframe id="preview" sandbox="allow-scripts" style="flex:1; min-width:0; height: 500px; border:1px solid #ccc;"></iframe>
  <div id="codeCol" style="flex:1; min-width:0;">
    <textarea id="codeEditor" spellcheck="false" style="width:100%; height:500px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px; line-height:1.4; border:1px solid #ccc; border-radius:4px; padding:8px;"></textarea>
  </div>
</div>

<!-- Module Manager Modal -->
<div id="moduleModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
  <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border-radius:8px; max-width:800px; width:90%; max-height:80%; overflow-y:auto;">
    <h2>📦 Module & Package Manager</h2>
    <div style="margin-bottom:15px;">
      <button id="closeModalBtn" style="float:right;">✕ Close</button>
      <button id="refreshModulesBtn">🔄 Refresh</button>
      <button id="uploadModuleModalBtn">📤 Upload Package</button>
    </div>
    <div style="clear:both;"></div>
    
    <h3>Available Modules</h3>
    <div id="modulesList" style="max-height:400px; overflow-y:auto;">
      <!-- Modules will be loaded here -->
    </div>
    
    <h3>Active Modules</h3>
    <div id="activeModulesList">
      <!-- Active modules will be shown here -->
    </div>
  </div>
</div>

<xml id="toolbox" style="display:none">
    <category name="UI" colour="120">
        <block type="add_view"></block>
        <block type="ui_heading"></block>
        <block type="ui_paragraph"></block>
        <block type="ui_html"></block>
        <block type="ui_image"></block>
        <block type="ui_container"></block>
        <block type="ui_button"></block>
        <block type="ui_link"></block>
        <block type="ui_list"></block>
        <block type="ui_table"></block>
        <block type="ui_input"></block>
        <block type="ui_row"></block>
        <block type="ui_col"></block>
        <block type="ui_divider"></block>
        <block type="ui_spacer"></block>
        <block type="ui_card"></block>
        <block type="ui_alert"></block>
        <block type="ui_code"></block>
        <block type="ui_svg_file"></block>
        <block type="ui_xml_file"></block>
    </category>
    <category name="Values" colour="160">
        <block type="text"></block>
        <block type="math_number"></block>
        <block type="json_object"></block>
        <block type="json_array"></block>
        <block type="json_property"></block>
    </category>
    <category id="apiCategory" name="API" colour="230"></category>
    <category id="scriptsCategory" name="Scripts" colour="290"></category>
</xml>

    <script>
        // Safe global alias to Blockly's JS generator to avoid Temporal Dead Zone issues
        // If Blockly is not yet available, provide a shim with a falsy forBlock
        var jsGen = (window.Blockly && window.Blockly.JavaScript) ? window.Blockly.JavaScript : { forBlock: null };

        // Define base blocks BEFORE workspace injection to avoid unknown block warnings
        try { defineBaseBlocks(); } catch (e) { console.error('defineBaseBlocks init failed', e); }

        const workspace = (window.workspace = Blockly.inject('blocklyDiv', { toolbox: document.getElementById('toolbox') }));

        // Controls: manual Run and Auto-run toggle
        let autoRunEnabled = true; // preview ON by default
        const debounce = window.Utils?.debounce || function(fn, delay){
            let t; return function(){ const ctx=this, args=arguments; clearTimeout(t); t=setTimeout(function(){ fn.apply(ctx,args); }, delay); };
        };
        const runCodeDebounced = debounce(runCode, 300);
        // Show auto toggle as enabled by default
        try { const t = document.getElementById('autoRunToggle'); if (t) { t.checked = true; } } catch(e){}
        const runBtn = document.getElementById('runBtn');
        if (runBtn) runBtn.addEventListener('click', runCode);
        const reloadApiBtn = document.getElementById('reloadApiBtn');
        if (reloadApiBtn) reloadApiBtn.addEventListener('click', async ()=>{
            try { await generateApiBlocks(); } catch(e){ console.error('Reload API failed', e); }
        });
        const openapiInput = document.getElementById('openapiUrl');
        if (openapiInput) openapiInput.addEventListener('keydown', async (e)=>{
            if (e.key === 'Enter') {
                e.preventDefault();
                try { await generateApiBlocks(); } catch(err){ console.error('Reload API failed', err); }
            }
        });

        // Module Management
        const moduleManagerBtn = document.getElementById('moduleManagerBtn');
        if (moduleManagerBtn) moduleManagerBtn.addEventListener('click', openModuleManager);
        
        const closeModalBtn = document.getElementById('closeModalBtn');
        if (closeModalBtn) closeModalBtn.addEventListener('click', closeModuleManager);
        
        const refreshModulesBtn = document.getElementById('refreshModulesBtn');
        if (refreshModulesBtn) refreshModulesBtn.addEventListener('click', loadAvailableModules);
        
        const uploadModuleBtn = document.getElementById('uploadModuleBtn');
        const moduleUpload = document.getElementById('moduleUpload');
        if (uploadModuleBtn) uploadModuleBtn.addEventListener('click', ()=> moduleUpload.click());
        if (moduleUpload) moduleUpload.addEventListener('change', uploadModuleFile);
        const autoToggle = document.getElementById('autoRunToggle');
        const autoStatus = document.getElementById('autoRunStatus');
        // Hide Auto-run UI per requirement
        try {
            autoToggle?.closest('label')?.setAttribute('style','display:none');
            if (autoStatus) autoStatus.style.display = 'none';
        } catch(e){}
        function updateAutoStatus(){ if (autoStatus) autoStatus.textContent = autoRunEnabled ? '(auto-run enabled)' : '(auto-run disabled)'; }
        if (autoToggle) {
            autoRunEnabled = true;
            updateAutoStatus();
            autoToggle.addEventListener('change', ()=>{
                autoRunEnabled = !!autoToggle.checked;
                updateAutoStatus();
                if (autoRunEnabled) runCodeDebounced();
            });
        }
        // Auto-run on workspace changes (debounced) and schedule autosave
        workspace.addChangeListener(function(e){
            if (autoRunEnabled) runCodeDebounced();
            if (!e || e.type !== Blockly.Events.SELECTED) scheduleAutosave();
        });

        // Code editor wiring (3rd pane) with CodeMirror
        const codeEditorTextarea = document.getElementById('codeEditor');
        let cm = null;
        if (window.CodeMirror && codeEditorTextarea) {
            cm = CodeMirror.fromTextArea(codeEditorTextarea, {
                lineNumbers: true,
                mode: 'htmlmixed',
                indentUnit: 2,
                tabSize: 2,
                viewportMargin: Infinity
            });
            try { cm.setSize('100%', '500px'); } catch(e){}
        }

        function getEditorValue(){ return cm ? cm.getValue() : (codeEditorTextarea ? codeEditorTextarea.value : ''); }
        function setEditorValue(v){ if (cm) cm.setValue(v); else if (codeEditorTextarea) codeEditorTextarea.value = v; }
        function getCaretIndex(){ return cm ? cm.indexFromPos(cm.getCursor()) : ((codeEditorTextarea && codeEditorTextarea.selectionStart) || 0); }
        function setCaretToIndex(idx){
            if (cm) { const pos = cm.posFromIndex(idx); cm.focus(); cm.setCursor(pos); cm.scrollIntoView({from:pos,to:pos}, 100); }
            else if (codeEditorTextarea) { codeEditorTextarea.focus(); codeEditorTextarea.setSelectionRange(idx, idx); }
        }

        // ---- Blockly XML compatibility helpers (v12+ moved XML utils) ----
        const xmlTextToDom = (window.Utils && window.Utils.xmlTextToDom)
          ? window.Utils.xmlTextToDom
          : function(text){
              try {
                  if (Blockly && Blockly.utils?.xml?.textToDom) return Blockly.utils.xml.textToDom(text);
                  if (Blockly && Blockly.Xml?.textToDom) return Blockly.Xml.textToDom(text);
              } catch(e) { console.warn('xmlTextToDom fallback', e); }
              try { const doc = new DOMParser().parseFromString(text, 'text/xml'); return doc && (doc.documentElement || doc); } catch(e){ return null; }
            };
        const xmlDomToText = (window.Utils && window.Utils.xmlDomToText)
          ? window.Utils.xmlDomToText
          : function(dom){
              try {
                  if (Blockly && Blockly.utils?.xml?.domToText) return Blockly.utils.xml.domToText(dom);
                  if (Blockly && Blockly.Xml?.domToText) return Blockly.Xml.domToText(dom);
              } catch(e) { console.warn('xmlDomToText fallback', e); }
              try { return new XMLSerializer().serializeToString(dom); } catch(e){ return ''; }
            };

        // Write HTML into the preview iframe via module
        function writeIframeHTML(html){ return window.Preview && window.Preview.writeIframeHTML ? window.Preview.writeIframeHTML(html) : undefined; }

        function updatePreviewFromEditor(){
            const html = getEditorValue();
            window.lastIframeHTML = html;
            writeIframeHTML(html);
        }
        const updatePreviewFromEditorDebounced = debounce(updatePreviewFromEditor, 300);
        if (cm) {
            cm.on('change', updatePreviewFromEditorDebounced);
            cm.on('cursorActivity', caretToBlocklyHighlight);
        } else {
            codeEditorTextarea?.addEventListener('input', updatePreviewFromEditorDebounced);
            codeEditorTextarea?.addEventListener('keyup', caretToBlocklyHighlight);
            codeEditorTextarea?.addEventListener('click', caretToBlocklyHighlight);
        }

        function caretToBlocklyHighlight(){
            const pos = getCaretIndex();
            const text = getEditorValue();
            const id = findLastEditorBlockId(text, pos);
            if (id) {
                try { workspace.highlightBlock(id); } catch(e){}
            }
        }
        function findLastEditorBlockId(text, upTo){
            // Prefer HTML data-bid markers in final HTML
            const htmlRe = /data-bid="([A-Za-z0-9_-]+)"/g;
            let m, lastId = null;
            const slice = text.slice(0, upTo);
            while ((m = htmlRe.exec(slice)) !== null) {
                lastId = m[1];
            }
            if (lastId) return lastId;
            // Fallback: legacy JS comment markers if editor shows JS
            const jsRe = /\/\*@@B:([A-Za-z0-9_-]+):(S|E)@@\*\//g;
            while ((m = jsRe.exec(slice)) !== null) {
                lastId = m[1];
            }
            return lastId;
        }
        // Scroll code editor to selected block in Blockly
        workspace.addChangeListener(function(e){
            try {
                if (e && e.type === Blockly.Events.SELECTED && e.newElementId) {
                    const id = e.newElementId;
                    // Find position of data-bid="id" in the editor's HTML
                    const text = getEditorValue();
                    const idx = text.indexOf('data-bid="'+id+'"');
                    if (idx >= 0) {
                        setCaretToIndex(idx);
                    }
                    // Send highlight request to preview iframe
                    try { document.getElementById('preview')?.contentWindow?.postMessage({type:'highlight', blockId: id}, '*'); } catch(_){}
                }
            } catch(err){}
        });

        // ---- Project Save/Load helpers ----
        const projectStatus = document.getElementById('projectStatus');
        function setPStatus(msg){ if (projectStatus) projectStatus.textContent = msg || ''; }
        function getProjectName(){ const el = document.getElementById('projectName'); return (el && el.value && el.value.trim()) ? el.value.trim() : 'project'; }
        // ---- Demo projects ----
        async function refreshDemoList(){
            try {
                const res = await fetch('/projects/demos');
                const data = await res.json();
                const sel = document.getElementById('demoList');
                if (!sel) return;
                sel.innerHTML = '';
                (data.xml || []).forEach(n=>{
                    const opt = document.createElement('option');
                    opt.value = n; opt.textContent = n; sel.appendChild(opt);
                });
            } catch(e){ console.warn('Demo list load failed', e); }
        }
        async function loadSelectedDemo(){
            const sel = document.getElementById('demoList');
            const n = sel && sel.value;
            if (!n) { setPStatus('Select demo'); return; }
            try {
                const res = await fetch('/projects/demo/'+encodeURIComponent(n));
                const data = await res.json();
                if (data && data.xml){
                    workspace.clear();
                    const dom = xmlTextToDom(data.xml);
                    Blockly.Xml.domToWorkspace(dom, workspace);
                    setDefaultProjectNameTimestamp(true);
                    setPStatus('Loaded demo: '+n);
                    if (autoRunEnabled) runCodeDebounced();
                    scheduleAutosave();
                }
            } catch(e){ console.error('Load demo failed', e); setPStatus('Load demo failed'); }
        }
        // ---- Autosave ----
        let autosaveEnabled = true;
        const AUTOSAVE_DELAY_MS = 10000; // 10s idle
        let autosaveTimer = null;
        let lastSavedXML = '';
        const autosaveStatus = document.getElementById('autosaveStatus');
        function updateAutosaveStatus(extra){
            const base = autosaveEnabled ? 'Autosave: ON' : 'Autosave: OFF';
            const tail = extra ? ' · '+extra : '';
            if (autosaveStatus) autosaveStatus.textContent = base + tail;
        }
        function autosaveProjectName(base){ return `${base}-autosave-${timestampString()}`; }
        function scheduleAutosave(){
            if (!autosaveEnabled) return;
            if (autosaveTimer) clearTimeout(autosaveTimer);
            autosaveTimer = setTimeout(autosaveNow, AUTOSAVE_DELAY_MS);
            updateAutosaveStatus('pending…');
        }
        async function autosaveNow(){
            try {
                if (!autosaveEnabled) return;
                const xmlDom = Blockly.Xml.workspaceToDom(workspace);
                const xmlText = Blockly.Xml.domToText(xmlDom);
                if (xmlText === lastSavedXML) { updateAutosaveStatus('no changes'); return; }
                const base = getProjectName();
                const name = autosaveProjectName(base);
                const res = await fetch('/projects/save',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name, xml: xmlText})});
                const data = await res.json();
                if (data.ok) {
                    lastSavedXML = xmlText;
                    const t = new Date().toLocaleTimeString();
                    updateAutosaveStatus('saved '+t);
                } else {
                    updateAutosaveStatus('error');
                    console.error('Autosave error', data);
                }
            } catch(e){
                updateAutosaveStatus('failed');
                console.error('Autosave failed', e);
            }
        }
        // Autosave toggle
        (function(){
            const tgl = document.getElementById('autosaveToggle');
            if (tgl) {
                autosaveEnabled = true;
                tgl.checked = true;
                tgl.addEventListener('change', ()=>{ autosaveEnabled = !!tgl.checked; updateAutosaveStatus(); if (autosaveEnabled) scheduleAutosave(); });
            }
            updateAutosaveStatus();
        })();
        async function refreshProjectList(){
            try {
                const res = await fetch('/projects');
                const data = await res.json();
                const sel = document.getElementById('projectList');
                if (!sel) return;
                sel.innerHTML = '';
                (data.xml || []).forEach(n=>{
                    const opt = document.createElement('option');
                    opt.value = n; opt.textContent = n; sel.appendChild(opt);
                });
                setPStatus('Projects loaded');
            } catch(e){ setPStatus('Failed to load projects'); console.error(e); }
        }
        async function saveProject(){
            try {
                const xmlDom = Blockly.Xml.workspaceToDom(workspace);
                const xmlText = xmlDomToText(xmlDom);
                const name = getProjectName();
                const res = await fetch('/projects/save',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name, xml: xmlText})});
                const data = await res.json();
                if (data.ok) { setPStatus('Saved: '+data.name); refreshProjectList(); }
                else { setPStatus('Save error'); console.error(data); }
            } catch(e){ setPStatus('Save failed'); console.error(e); }
        }
        async function loadProject(name){
            const n = name || (document.getElementById('projectList')?.value);
            if (!n) { setPStatus('Select project'); return; }
            try {
                const res = await fetch('/projects/'+encodeURIComponent(n));
                const data = await res.json();
                if (data.xml){
                    workspace.clear();
                    const dom = xmlTextToDom(data.xml);
                    Blockly.Xml.domToWorkspace(dom, workspace);
                    setPStatus('Loaded: '+n);
                    if (autoRunEnabled) runCodeDebounced();
                    scheduleAutosave();
                } else { setPStatus('Load error'); console.error(data); }
            } catch(e){ setPStatus('Load failed'); console.error(e); }
        }
        async function saveHtml(){
            try {
                // Ensure we have latest preview
                if (!window.lastIframeHTML) runCode();
                const name = getProjectName();
                const res = await fetch('/projects/save_html',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name, html: window.lastIframeHTML || ''})});
                const data = await res.json();
                if (data.ok) { setPStatus('HTML saved: '+data.name); }
                else { setPStatus('HTML save error'); console.error(data); }
            } catch(e){ setPStatus('HTML save failed'); console.error(e); }
        }
        function openHtml(){
            const name = getProjectName();
            window.open('/projects/html/'+encodeURIComponent(name), '_blank');
        }
        // Buttons wiring
        document.getElementById('refreshProjectsBtn')?.addEventListener('click', refreshProjectList);
        document.getElementById('saveProjectBtn')?.addEventListener('click', saveProject);
        document.getElementById('saveHtmlBtn')?.addEventListener('click', saveHtml);
        document.getElementById('openHtmlBtn')?.addEventListener('click', openHtml);

        // ---- Uploads (SVG/XML) ----
        async function refreshUploads(){
            try {
                const res = await fetch('/uploads');
                const data = await res.json();
                const sel = document.getElementById('uploadsList');
                if (!sel) return;
                sel.innerHTML = '';
                (data.all || []).forEach(fn=>{
                    const opt = document.createElement('option');
                    opt.value = fn; opt.textContent = fn; sel.appendChild(opt);
                });
            } catch(e){ console.error('Uploads list error', e); }
        }
        async function uploadSelectedFile(){
            const inp = document.getElementById('uploadInput');
            if (!inp || !inp.files || inp.files.length === 0) return;
            const file = inp.files[0];
            const fd = new FormData();
            fd.append('file', file);
            try {
                const res = await fetch('/uploads/upload', { method:'POST', body: fd });
                const data = await res.json();
                if (data.ok){
                    setPStatus('Uploaded: '+data.filename);
                    await refreshUploads();
                } else {
                    setPStatus('Upload error'); console.error(data);
                }
            } catch(e){ setPStatus('Upload failed'); console.error(e); }
        }
        function openSelectedUpload(){
            const sel = document.getElementById('uploadsList');
            const fn = sel && sel.value;
            if (fn) window.open('/uploads/'+encodeURIComponent(fn), '_blank');
        }
        const timestampString = (window.Utils && window.Utils.timestampString)
          ? window.Utils.timestampString
          : function(){ const d=new Date(); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`; };
        function setDefaultProjectNameTimestamp(force){
            const pn = document.getElementById('projectName');
            if (!pn) return;
            if (force || !pn.value) pn.value = timestampString();
        }
        async function loadUploadAsWorkspace(){
            const sel = document.getElementById('uploadsList');
            const fn = sel && sel.value;
            if (!fn || !fn.toLowerCase().endsWith('.xml')) { setPStatus('Select an XML file'); return; }
            try {
                const res = await fetch('/uploads/'+encodeURIComponent(fn));
                const xmlText = await res.text();
                const dom = xmlTextToDom(xmlText);
                workspace.clear();
                Blockly.Xml.domToWorkspace(dom, workspace);
                setPStatus('Workspace loaded from: '+fn);
                setDefaultProjectNameTimestamp(true);
                if (autoRunEnabled) runCodeDebounced();
            } catch(e){ setPStatus('Failed to load into workspace'); console.error(e); }
        }
        document.getElementById('uploadBtn')?.addEventListener('click', uploadSelectedFile);
        document.getElementById('openUploadBtn')?.addEventListener('click', openSelectedUpload);
        document.getElementById('loadXmlToWorkspaceBtn')?.addEventListener('click', loadUploadAsWorkspace);
        document.getElementById('loadProjectBtn')?.addEventListener('click', async ()=>{
            const sel = document.getElementById('projectList');
            const name = sel && sel.value; if (!name) return;
            try { const res = await fetch('/projects/'+encodeURIComponent(name)); const data = await res.json();
                if (data && data.xml){ const dom = xmlTextToDom(data.xml); workspace.clear(); Blockly.Xml.domToWorkspace(dom, workspace); setPStatus('Loaded project: '+name); setDefaultProjectNameTimestamp(true); if (autoRunEnabled) runCodeDebounced(); }
            } catch(e){ console.error(e); setPStatus('Load project failed'); }
        });
        document.getElementById('loadDemoBtn')?.addEventListener('click', loadSelectedDemo);

    // Block definitions will be handled in initializeBlocks()

    // --- Funkcja: Generowanie bloków API z OpenAPI ---
    async function generateApiBlocks(url) {
        const src = (url || document.getElementById('openapiUrl')?.value || '').trim() || "https://petstore.swagger.io/v2/swagger.json";
        const spec = await loadOpenAPI(src);
        const apiCategory = document.getElementById("apiCategory");

        // Clear previous API blocks from toolbox category
        if (apiCategory) {
            while (apiCategory.firstChild) apiCategory.removeChild(apiCategory.firstChild);
        }

        // Determine base URL (supports OpenAPI v2 and v3). Fallback to current origin.
        let baseUrl = '';
        try {
            const isV3 = !!spec.openapi;
            if (isV3) {
                baseUrl = (spec.servers && spec.servers[0] && spec.servers[0].url) || '';
            } else {
                const scheme = (spec.schemes && spec.schemes[0]) || 'http';
                const host = spec.host || '';
                const basePath = spec.basePath || '';
                baseUrl = (host ? `${scheme}://${host}` : '') + basePath;
            }
            // Normalize relative baseUrl to absolute using parent's origin
            if (!baseUrl) baseUrl = window.location.origin;
            if (/^\/.*/.test(baseUrl)) {
                baseUrl = window.location.origin + baseUrl;
            } else if (!/^https?:\/\//i.test(baseUrl)) {
                baseUrl = window.location.origin.replace(/\/$/, '') + '/' + baseUrl.replace(/^\//, '');
            }
            // Remove trailing slash for clean concatenation
            baseUrl = baseUrl.replace(/\/$/, '');
        } catch(e) { console.warn('Failed to resolve baseUrl from OpenAPI spec; using origin', e); baseUrl = window.location.origin; }

        Object.entries(spec.paths).forEach(([path, methods]) => {
            Object.entries(methods).forEach(([method, details]) => {
                const blockName = `api_${method}_${path.replace(/[\/{}]/g, "_")}`;
                const summary = details.summary || `${method.toUpperCase()} ${path}`;
                const parameters = details.parameters || [];

                // Dodaj blok do toolbox
                const blockEl = document.createElement("block");
                blockEl.setAttribute("type", blockName);
                apiCategory.appendChild(blockEl);

                // Parse parameters
                const pathParams = parameters.filter(p => p.in === 'path');
                const queryParams = parameters.filter(p => p.in === 'query');
                const bodyParam = parameters.find(p => p.in === 'body');
                const hasBody = method.toLowerCase() === 'post' || method.toLowerCase() === 'put';

                // Definicja bloku z parametrami
                Blockly.Blocks[blockName] = {
                    init: function() {
                        this.appendDummyInput().appendField(summary);
                        
                        // Add path parameter inputs
                        pathParams.forEach(param => {
                            this.appendValueInput(`PATH_${param.name.toUpperCase()}`)
                                .appendField(param.name + " (path):")
                                .setCheck(["String", "Number"]);
                        });

                        // Add query parameter inputs
                        queryParams.forEach(param => {
                            this.appendValueInput(`QUERY_${param.name.toUpperCase()}`)
                                .appendField(param.name + " (query):")
                                .setCheck(["String", "Number"]);
                        });

                        // Add body input for POST/PUT
                        if (hasBody && bodyParam) {
                            this.appendValueInput("BODY")
                                .appendField("Request Body (JSON):")
                                .setCheck("String");
                        }

                        this.setPreviousStatement(true, null);
                        this.setNextStatement(true, null);
                        this.setColour(230);
                    }
                };

                // Kod JS z bloku (typed generator API with legacy fallback)
                const apiJS = Blockly.JavaScript;
                const generateCode = function(block, generator) {
                    let actualPath = path;
                    const queryParts = [];
                    let bodyCode = '';

                    // Handle path parameters
                    pathParams.forEach(param => {
                        const inputName = `PATH_${param.name.toUpperCase()}`;
                        const value = generator ?
                            (generator.valueToCode(block, inputName, generator.ORDER_NONE) || `"${param.default || ''}"`) :
                            (Blockly.JavaScript.valueToCode(block, inputName, Blockly.JavaScript.ORDER_NONE) || `"${param.default || ''}"`);
                        actualPath = actualPath.replace(`{${param.name}}`, '" + ' + value + ' + "');
                    });

                    // Handle query parameters
                    queryParams.forEach(param => {
                        const inputName = `QUERY_${param.name.toUpperCase()}`;
                        const value = generator ?
                            (generator.valueToCode(block, inputName, generator.ORDER_NONE)) :
                            (Blockly.JavaScript.valueToCode(block, inputName, Blockly.JavaScript.ORDER_NONE));
                        if (value) {
                            queryParts.push(`${param.name}=" + encodeURIComponent(${value}) + "`);
                        }
                    });

                    // Build URL with query string
                    let fullUrl = `"${baseUrl}${actualPath}"`;
                    if (queryParts.length > 0) {
                        fullUrl += ' + "?" + "' + queryParts.join(' + "&" + "') + '"';
                    }

                    // Handle request body for POST/PUT
                    if (hasBody && bodyParam) {
                        const bodyValue = generator ?
                            (generator.valueToCode(block, 'BODY', generator.ORDER_NONE) || '"{}"') :
                            (Blockly.JavaScript.valueToCode(block, 'BODY', Blockly.JavaScript.ORDER_NONE) || '"{}"');
                        bodyCode = `, {
                            method: "${method.toUpperCase()}",
                            headers: {"Content-Type": "application/json"},
                            body: ${bodyValue}
                        }`;
                    } else if (method.toLowerCase() !== 'get') {
                        bodyCode = `, {method: "${method.toUpperCase()}"}`;
                    }

                    return `
              htmlOutput += '<pre id="${blockName}">Ładowanie...</pre>';
              fetch(${fullUrl}${bodyCode})
                .then(r => r.json())
                .then(data => {
                  document.getElementById("${blockName}").innerText = JSON.stringify(data,null,2);
                })
                .catch(err => {
                  document.getElementById("${blockName}").innerText = "Error: " + err.message;
                });
            `;
                };

                if (apiJS && apiJS.forBlock) {
                    apiJS.forBlock[blockName] = generateCode;
                } else {
                    Blockly.JavaScript[blockName] = generateCode;
                }
            });
        });

        // Refresh toolbox so new API blocks appear - with better error handling
        try { 
            const toolboxElement = document.getElementById('toolbox');
            if (toolboxElement && workspace) {
                workspace.updateToolbox(toolboxElement); 
            }
        } catch(e) { 
            console.warn('Toolbox update failed:', e); 
            // Fallback: try to refresh workspace without error
            try {
                if (workspace && workspace.refreshToolboxSelection) {
                    workspace.refreshToolboxSelection();
                }
            } catch(e2) {
                console.warn('Toolbox refresh fallback failed:', e2);
            }
        }
    }

    async function loadOpenAPI(url) {
        const res = await fetch(url);
        return res.json();
    }

    // Module Manager moved to ide/js/modules/manager.js

    // --- Generowanie wynikowego HTML ---
    function buildIframeHTML(code) { return window.Preview && window.Preview.buildIframeHTML ? window.Preview.buildIframeHTML(code) : ''; }

    function runCode() { return window.Preview && window.Preview.runCode ? window.Preview.runCode() : undefined; }

    // Define all blocks in initialization function to ensure proper timing
    function defineBaseBlocks() {
        // Guard against multiple initializations
        try { if (Blockly && Blockly.Blocks && Blockly.Blocks['add_view']) return true; } catch(_){ }
        // --- Prosty blok UI (widok) ---
        Blockly.Blocks['add_view'] = {
            init: function() {
                this.appendDummyInput().appendField("Dodaj widok").appendField(new Blockly.FieldTextInput("Widok"), "VIEW");
                this.appendStatementInput("CONTENT").setCheck(null).appendField("zawiera");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(120);
            }
        };
        // ui_svg_file: renders uploaded SVG by <img>
        Blockly.Blocks['ui_svg_file'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("SVG file")
                    .appendField(new Blockly.FieldTextInput("example.svg"), "FILENAME");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(120);
            }
        };
        // ui_xml_file: embeds uploaded XML with height
        Blockly.Blocks['ui_xml_file'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("XML file")
                    .appendField(new Blockly.FieldTextInput("example.xml"), "FILENAME")
                    .appendField("height")
                    .appendField(new Blockly.FieldTextInput("400"), "HEIGHT");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(120);
            }
        };

        // Ensure JavaScript generator is properly defined
        if (!Blockly.JavaScript) {
            console.error("Blockly.JavaScript is not available!");
            return false;
        }

        const codeJS = Blockly.JavaScript;
        // Inject block-id markers into generated code for synchronization with the code editor
        try {
            codeJS.STATEMENT_PREFIX = '/*@@B:%1:S@@*/\n';
            codeJS.STATEMENT_SUFFIX = '\n/*@@B:%1:E@@*/\n';
        } catch(e) { console.warn('Could not set statement markers', e); }
        if (codeJS.forBlock) {
            codeJS.forBlock['add_view'] = function(block, generator) {
                const name = block.getFieldValue('VIEW');
                const content = generator.statementToCode(block, 'CONTENT');
                return `
(function(){
  const __prev = htmlOutput;
  htmlOutput = "";
  ${content}
  const __children = htmlOutput;
  htmlOutput = __prev;
  views.push({name:"${name}", bid:"${block.id}", html: __children});
})();
`;
            };
        } else {
            Blockly.JavaScript['add_view'] = function(block) {
                const name = block.getFieldValue('VIEW');
                const content = Blockly.JavaScript.statementToCode(block, 'CONTENT');
                return `
(function(){
  const __prev = htmlOutput;
  htmlOutput = "";
  ${content}
  const __children = htmlOutput;
  htmlOutput = __prev;
  views.push({name:"${name}", bid:"${block.id}", html: __children});
})();
`;
            };
        }

        // Verify the generator was registered
        console.log("add_view generator registered (forBlock):", jsGen.forBlock ? typeof jsGen.forBlock['add_view'] : 'no forBlock');
        console.log("add_view generator registered (legacy):", typeof Blockly.JavaScript['add_view']);

        // --- Additional UI blocks ---
        // ui_heading: level H1/H2/H3 + text
        Blockly.Blocks['ui_heading'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("Nagłówek")
                    .appendField(new Blockly.FieldDropdown([["H1","1"],["H2","2"],["H3","3"],["H4","4"],["H5","5"],["H6","6"]]), "LEVEL")
                    .appendField(new Blockly.FieldTextInput("Tytuł"), "TEXT");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(120);
            }
        };
        if (jsGen.forBlock) {
            jsGen.forBlock['ui_heading'] = function(block, generator) {
                const level = block.getFieldValue('LEVEL') || '1';
                const text = block.getFieldValue('TEXT') || '';
                return `appendHtmlWithBid('${block.id}', \`<h${level}>${text}</h${level}>\`);\n`;
            };
        } else {
            Blockly.JavaScript['ui_heading'] = function(block) {
                const level = block.getFieldValue('LEVEL') || '1';
                const text = block.getFieldValue('TEXT') || '';
                return `appendHtmlWithBid('${block.id}', \`<h${level}>${text}</h${level}>\`);\n`;
            };
        }

        // ui_paragraph: multiline text → <p>
        Blockly.Blocks['ui_paragraph'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("Akapit")
                    .appendField(new Blockly.FieldTextInput("Treść akapitu"), "TEXT");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(120);
            }
        };
        if (jsGen.forBlock) {
            jsGen.forBlock['ui_paragraph'] = function(block, generator) {
                const text = (block.getFieldValue('TEXT') || '').replace(/`/g, '\\`');
                return `appendHtmlWithBid('${block.id}', \`<p>${text}</p>\`);\n`;
            };
        } else {
            Blockly.JavaScript['ui_paragraph'] = function(block) {
                const text = (block.getFieldValue('TEXT') || '').replace(/`/g, '\\`');
                return `appendHtmlWithBid('${block.id}', \`<p>${text}</p>\`);\n`;
            };
        }

        // ui_html: raw HTML passthrough
        Blockly.Blocks['ui_html'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("HTML")
                    .appendField(new Blockly.FieldTextInput("<div>Własny HTML</div>"), "HTML");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(120);
            }
        };
        if (jsGen.forBlock) {
            jsGen.forBlock['ui_html'] = function(block, generator) {
                const html = (block.getFieldValue('HTML') || '').replace(/`/g, '\\`');
                return `appendHtmlWithBid('${block.id}', \`${html}\`);\n`;
            };
        } else {
            Blockly.JavaScript['ui_html'] = function(block) {
                const html = (block.getFieldValue('HTML') || '').replace(/`/g, '\\`');
                return `appendHtmlWithBid('${block.id}', \`${html}\`);\n`;
            };
        }

        // ui_image: <img src alt width>
        Blockly.Blocks['ui_image'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("Obraz")
                    .appendField("URL", "")
                    .appendField(new Blockly.FieldTextInput("https://sapletta.github.io/about/image.png"), "SRC");
                this.appendDummyInput()
                    .appendField("ALT")
                    .appendField(new Blockly.FieldTextInput("obraz"), "ALT");
                this.appendDummyInput()
                    .appendField("Szerokość")
                    .appendField(new Blockly.FieldNumber(300, 0, 10000, 1), "WIDTH");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(120);
            }
        };
        if (jsGen.forBlock) {
            jsGen.forBlock['ui_image'] = function(block, generator) {
                const src = block.getFieldValue('SRC') || '';
                const alt = block.getFieldValue('ALT') || '';
                const width = block.getFieldValue('WIDTH');
                const widthAttr = width ? ` width=\"${width}\"` : '';
                return `appendHtmlWithBid('${block.id}', \`<img src=\"${src}\" alt=\"${alt}\"${widthAttr}>\`);\n`;
            };
        } else {
            Blockly.JavaScript['ui_image'] = function(block) {
                const src = block.getFieldValue('SRC') || '';
                const alt = block.getFieldValue('ALT') || '';
                const width = block.getFieldValue('WIDTH');
                const widthAttr = width ? ` width=\"${width}\"` : '';
                return `appendHtmlWithBid('${block.id}', \`<img src=\"${src}\" alt=\"${alt}\"${widthAttr}>\`);\n`;
            };
        }

        // ui_container: <div class> with children
        Blockly.Blocks['ui_container'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("Kontener klasa")
                    .appendField(new Blockly.FieldTextInput("container"), "CLASS");
                this.appendStatementInput("CHILDREN").setCheck(null).appendField("zawiera");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(120);
            }
        };
        if (jsGen.forBlock) {
            jsGen.forBlock['ui_container'] = function(block, generator) {
                const klass = block.getFieldValue('CLASS') || '';
                const children = generator.statementToCode(block, 'CHILDREN');
                return `
(function(){
  const __prev = htmlOutput;
  htmlOutput = "";
  ${children}
  const __children = htmlOutput;
  htmlOutput = __prev;
  appendHtmlWithBid('${block.id}', '<div class="${klass}">\n' + __children + '</div>\n');
})();
`;
            };
        } else {
            Blockly.JavaScript['ui_container'] = function(block) {
                const klass = block.getFieldValue('CLASS') || '';
                const children = Blockly.JavaScript.statementToCode(block, 'CHILDREN');
                return `
(function(){
  const __prev = htmlOutput;
  htmlOutput = "";
  ${children}
  const __children = htmlOutput;
  htmlOutput = __prev;
  appendHtmlWithBid('${block.id}', '<div class="${klass}">\n' + __children + '</div>\n');
})();
`;
            };
        }

        // ui_button: <button onclick>Text</button>
        Blockly.Blocks['ui_button'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("Przycisk")
                    .appendField(new Blockly.FieldTextInput("Kliknij"), "TEXT");
                this.appendDummyInput()
                    .appendField("onclick JS")
                    .appendField(new Blockly.FieldTextInput("alert('Klik!')"), "ONCLICK");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(120);
            }
        };
        if (jsGen.forBlock) {
            jsGen.forBlock['ui_button'] = function(block, generator) {
                const text = (block.getFieldValue('TEXT') || '').replace(/`/g, '\\`');
                const oc = (block.getFieldValue('ONCLICK') || '').replace(/`/g, '\\`');
                const ocAttr = oc ? ` onclick=\"${oc}\"` : '';
                return `appendHtmlWithBid('${block.id}', \`<button${ocAttr}>${text}</button>\`);\n`;
            };
        } else {
            Blockly.JavaScript['ui_button'] = function(block) {
                const text = (block.getFieldValue('TEXT') || '').replace(/`/g, '\\`');
                const oc = (block.getFieldValue('ONCLICK') || '').replace(/`/g, '\\`');
                const ocAttr = oc ? ` onclick=\"${oc}\"` : '';
                return `appendHtmlWithBid('${block.id}', \`<button${ocAttr}>${text}</button>\`);\n`;
            };
        }

        // ui_link: <a href target>Text</a>
        Blockly.Blocks['ui_link'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("Link")
                    .appendField(new Blockly.FieldTextInput("https://example.com"), "HREF");
                this.appendDummyInput()
                    .appendField("tekst")
                    .appendField(new Blockly.FieldTextInput("Odwiedź"), "TEXT");
                this.appendDummyInput()
                    .appendField("target")
                    .appendField(new Blockly.FieldDropdown([["_self","_self"],["_blank","_blank"]]), "TARGET");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(120);
            }
        };
        if (jsGen.forBlock) {
            jsGen.forBlock['ui_link'] = function(block, generator) {
                const href = (block.getFieldValue('HREF') || '').replace(/`/g, '\\`');
                const text = (block.getFieldValue('TEXT') || '').replace(/`/g, '\\`');
                const target = block.getFieldValue('TARGET') || '_self';
                return `appendHtmlWithBid('${block.id}', \`<a href=\"${href}\" target=\"${target}\">${text}</a>\`);\n`;
            };
        } else {
            Blockly.JavaScript['ui_link'] = function(block) {
                const href = (block.getFieldValue('HREF') || '').replace(/`/g, '\\`');
                const text = (block.getFieldValue('TEXT') || '').replace(/`/g, '\\`');
                const target = block.getFieldValue('TARGET') || '_self';
                return `appendHtmlWithBid('${block.id}', \`<a href=\"${href}\" target=\"${target}\">${text}</a>\`);\n`;
            };
        }

        // ui_list: <ul><li>..</li></ul> from multiline items
        Blockly.Blocks['ui_list'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("Lista (pozycje w liniach)")
                    .appendField(new Blockly.FieldTextInput("element 1\nelement 2"), "ITEMS");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(120);
            }
        };
        if (jsGen.forBlock) {
            jsGen.forBlock['ui_list'] = function(block, generator) {
                const itemsRaw = (block.getFieldValue('ITEMS') || '');
                const items = itemsRaw.split(/\r?\n/).filter(s=>s.trim().length>0).map(s=>s.replace(/`/g,'\\`'));
                const lis = items.map(it=>`<li>${it}</li>`).join('');
                return `appendHtmlWithBid('${block.id}', \`<ul>${lis}</ul>\`);\n`;
            };
        } else {
            Blockly.JavaScript['ui_list'] = function(block) {
                const itemsRaw = (block.getFieldValue('ITEMS') || '');
                const items = itemsRaw.split(/\r?\n/).filter(s=>s.trim().length>0).map(s=>s.replace(/`/g,'\\`'));
                const lis = items.map(it=>`<li>${it}</li>`).join('');
                return `appendHtmlWithBid('${block.id}', \`<ul>${lis}</ul>\`);\n`;
            };
        }

        // ui_table: simple rows (newline) and cols (pipe | separated)
        Blockly.Blocks['ui_table'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("Tabela (wiersze oddzielone \n, kolumny |)")
                    .appendField(new Blockly.FieldTextInput("A|B|C\n1|2|3"), "ROWS");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(120);
            }
        };
        if (jsGen.forBlock) {
            jsGen.forBlock['ui_table'] = function(block, generator) {
                const rowsRaw = (block.getFieldValue('ROWS') || '').split(/\r?\n/).filter(r=>r.trim().length>0);
                const trs = rowsRaw.map(r=>{
                    const tds = r.split('|').map(c=>`<td>${c.replace(/`/g,'\\`').trim()}</td>`).join('');
                    return `<tr>${tds}</tr>`;
                }).join('');
                return `appendHtmlWithBid('${block.id}', \`<table border=\"1\">${trs}</table>\`);\n`;
            };
        } else {
            Blockly.JavaScript['ui_table'] = function(block) {
                const rowsRaw = (block.getFieldValue('ROWS') || '').split(/\r?\n/).filter(r=>r.trim().length>0);
                const trs = rowsRaw.map(r=>{
                    const tds = r.split('|').map(c=>`<td>${c.replace(/`/g,'\\`').trim()}</td>`).join('');
                    return `<tr>${tds}</tr>`;
                }).join('');
                return `appendHtmlWithBid('${block.id}', \`<table border=\"1\">${trs}</table>\`);\n`;
            };
        }

        // ui_input: labeled input
        Blockly.Blocks['ui_input'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("Pole")
                    .appendField("etykieta")
                    .appendField(new Blockly.FieldTextInput("Label"), "LABEL");
                this.appendDummyInput()
                    .appendField("nazwa")
                    .appendField(new Blockly.FieldTextInput("name"), "NAME");
                this.appendDummyInput()
                    .appendField("typ")
                    .appendField(new Blockly.FieldDropdown([["text","text"],["number","number"],["email","email"],["password","password"],["date","date"]]), "TYPE");
                this.appendDummyInput()
                    .appendField("placeholder")
                    .appendField(new Blockly.FieldTextInput(""), "PH");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(120);
            }
        };
        if (jsGen.forBlock) {
            jsGen.forBlock['ui_input'] = function(block, generator) {
                const label = (block.getFieldValue('LABEL') || '').replace(/`/g,'\\`');
                const name = (block.getFieldValue('NAME') || '').replace(/`/g,'\\`');
                const type = block.getFieldValue('TYPE') || 'text';
                const ph = (block.getFieldValue('PH') || '').replace(/`/g,'\\`');
                const phAttr = ph ? ` placeholder=\"${ph}\"` : '';
                return `appendHtmlWithBid('${block.id}', \`<label>${label}: <input type=\"${type}\" name=\"${name}\"${phAttr}></label>\`);\n`;
            };
        } else {
            Blockly.JavaScript['ui_input'] = function(block) {
                const label = (block.getFieldValue('LABEL') || '').replace(/`/g,'\\`');
                const name = (block.getFieldValue('NAME') || '').replace(/`/g,'\\`');
                const type = block.getFieldValue('TYPE') || 'text';
                const ph = (block.getFieldValue('PH') || '').replace(/`/g,'\\`');
                const phAttr = ph ? ` placeholder=\"${ph}\"` : '';
                return `appendHtmlWithBid('${block.id}', \`<label>${label}: <input type=\"${type}\" name=\"${name}\"${phAttr}></label>\`);\n`;
            };
        }

        // ui_row: flex row container
        Blockly.Blocks['ui_row'] = {
            init: function() {
                this.appendDummyInput().appendField("Wiersz (flex)");
                this.appendStatementInput("CHILDREN").setCheck(null).appendField("zawiera");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(120);
            }
        };
        if (jsGen.forBlock) {
            jsGen.forBlock['ui_row'] = function(block, generator) {
                const children = generator.statementToCode(block, 'CHILDREN');
                const style = 'display:flex; gap:10px; flex-wrap:wrap;';
                return `
(function(){
  const __prev = htmlOutput;
  htmlOutput = "";
  ${children}
  const __children = htmlOutput;
  htmlOutput = __prev;
  appendHtmlWithBid('${block.id}', '<div style="${style}">\n' + __children + '</div>\n');
})();
`;
            };
        } else {
            Blockly.JavaScript['ui_row'] = function(block) {
                const children = Blockly.JavaScript.statementToCode(block, 'CHILDREN');
                const style = 'display:flex; gap:10px; flex-wrap:wrap;';
                return `
(function(){
  const __prev = htmlOutput;
  htmlOutput = "";
  ${children}
  const __children = htmlOutput;
  htmlOutput = __prev;
  appendHtmlWithBid('${block.id}', '<div style="${style}">\n' + __children + '</div>\n');
})();
`;
            };
        }

        // ui_col: flex column with width percentage
        Blockly.Blocks['ui_col'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("Kolumna %")
                    .appendField(new Blockly.FieldNumber(50, 0, 100, 1), "WIDTH");
                this.appendStatementInput("CHILDREN").setCheck(null).appendField("zawiera");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(120);
            }
        };
        if (jsGen.forBlock) {
            jsGen.forBlock['ui_col'] = function(block, generator) {
                const w = Number(block.getFieldValue('WIDTH') || 50);
                const children = generator.statementToCode(block, 'CHILDREN');
                const style = `flex: 0 0 ${w}%; max-width: ${w}%;`;
                return `
(function(){
  const __prev = htmlOutput;
  htmlOutput = "";
  ${children}
  const __children = htmlOutput;
  htmlOutput = __prev;
  appendHtmlWithBid('${block.id}', '<div style="${style}">\n' + __children + '</div>\n');
})();
`;
            };
        } else {
            Blockly.JavaScript['ui_col'] = function(block) {
                const w = Number(block.getFieldValue('WIDTH') || 50);
                const children = Blockly.JavaScript.statementToCode(block, 'CHILDREN');
                const style = `flex: 0 0 ${w}%; max-width: ${w}%;`;
                return `
(function(){
  const __prev = htmlOutput;
  htmlOutput = "";
  ${children}
  const __children = htmlOutput;
  htmlOutput = __prev;
  appendHtmlWithBid('${block.id}', '<div style="${style}">\n' + __children + '</div>\n');
})();
`;
            };
        }

        // ui_divider: <hr>
        Blockly.Blocks['ui_divider'] = {
            init: function() {
                this.appendDummyInput().appendField("Separator");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(120);
            }
        };
        if (jsGen.forBlock) {
            jsGen.forBlock['ui_divider'] = function(block, generator) {
                return `appendHtmlWithBid('${block.id}', \`<hr>\`);\n`;
            };
        } else {
            Blockly.JavaScript['ui_divider'] = function(block) {
                return `appendHtmlWithBid('${block.id}', \`<hr>\`);\n`;
            };
        }

        // ui_spacer: empty div with height
        Blockly.Blocks['ui_spacer'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("Odstęp px")
                    .appendField(new Blockly.FieldNumber(16, 0, 1000, 1), "HEIGHT");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(120);
            }
        };
        if (jsGen.forBlock) {
            jsGen.forBlock['ui_spacer'] = function(block, generator) {
                const h = Number(block.getFieldValue('HEIGHT') || 16);
                return `appendHtmlWithBid('${block.id}', \`<div style=\"height:${h}px\"></div>\`);\n`;
            };
        } else {
            Blockly.JavaScript['ui_spacer'] = function(block) {
                const h = Number(block.getFieldValue('HEIGHT') || 16);
                return `appendHtmlWithBid('${block.id}', \`<div style=\"height:${h}px\"></div>\`);\n`;
            };
        }

        // ui_card: simple card with title and children
        Blockly.Blocks['ui_card'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("Karta tytuł")
                    .appendField(new Blockly.FieldTextInput("Tytuł"), "TITLE");
                this.appendStatementInput("CHILDREN").setCheck(null).appendField("zawiera");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(120);
            }
        };
        if (jsGen.forBlock) {
            jsGen.forBlock['ui_card'] = function(block, generator) {
                const title = (block.getFieldValue('TITLE') || '').replace(/`/g,'\\`');
                const children = generator.statementToCode(block, 'CHILDREN');
                const style = 'border:1px solid #ddd; padding:12px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.05);';
                return `
(function(){
  const __prev = htmlOutput;
  htmlOutput = "";
  ${children}
  const __children = htmlOutput;
  htmlOutput = __prev;
  appendHtmlWithBid('${block.id}', '<div style="${style}">\n' + '<h3>${title}</h3>\n' + __children + '</div>\n');
})();
`;
            };
        } else {
            Blockly.JavaScript['ui_card'] = function(block) {
                const title = (block.getFieldValue('TITLE') || '').replace(/`/g,'\\`');
                const children = Blockly.JavaScript.statementToCode(block, 'CHILDREN');
                const style = 'border:1px solid #ddd; padding:12px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.05);';
                return `
(function(){
  const __prev = htmlOutput;
  htmlOutput = "";
  ${children}
  const __children = htmlOutput;
  htmlOutput = __prev;
  appendHtmlWithBid('${block.id}', '<div style="${style}">\n' + '<h3>${title}</h3>\n' + __children + '</div>\n');
})();
`;
            };
        }

        // ui_alert: colored message box
        Blockly.Blocks['ui_alert'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("Alert")
                    .appendField(new Blockly.FieldDropdown([["info","info"],["success","success"],["warning","warning"],["error","error"]]), "KIND");
                this.appendDummyInput()
                    .appendField("tekst")
                    .appendField(new Blockly.FieldTextInput("Wiadomość"), "TEXT");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(120);
            }
        };
        if (jsGen.forBlock) {
            jsGen.forBlock['ui_alert'] = function(block, generator) {
                const kind = block.getFieldValue('KIND') || 'info';
                const text = (block.getFieldValue('TEXT') || '').replace(/`/g,'\\`');
                const color = {info:'#eef6ff', success:'#ecfdf5', warning:'#fffbeb', error:'#fef2f2'}[kind] || '#eef6ff';
                const border = {info:'#bfdbfe', success:'#bbf7d0', warning:'#fde68a', error:'#fecaca'}[kind] || '#bfdbfe';
                return `appendHtmlWithBid('${block.id}', \`<div style=\"background:${color}; border:1px solid ${border}; padding:10px; border-radius:6px;\">${text}</div>\`);\n`;
            };
        } else {
            Blockly.JavaScript['ui_alert'] = function(block) {
                const kind = block.getFieldValue('KIND') || 'info';
                const text = (block.getFieldValue('TEXT') || '').replace(/`/g,'\\`');
                const color = {info:'#eef6ff', success:'#ecfdf5', warning:'#fffbeb', error:'#fef2f2'}[kind] || '#eef6ff';
                const border = {info:'#bfdbfe', success:'#bbf7d0', warning:'#fde68a', error:'#fecaca'}[kind] || '#bfdbfe';
                return `appendHtmlWithBid('${block.id}', \`<div style=\"background:${color}; border:1px solid ${border}; padding:10px; border-radius:6px;\">${text}</div>\`);\n`;
            };
        }

        // ui_code: preformatted code block
        Blockly.Blocks['ui_code'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("Kod")
                    .appendField(new Blockly.FieldDropdown([["plaintext","plaintext"],["js","javascript"],["py","python"],["bash","bash"],["json","json"]]), "LANG");
                this.appendDummyInput()
                    .appendField(new Blockly.FieldTextInput("console.log('hello');"), "CODE");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(120);
            }
        };
        if (jsGen.forBlock) {
            jsGen.forBlock['ui_code'] = function(block, generator) {
                const lang = block.getFieldValue('LANG') || 'plaintext';
                const code = (block.getFieldValue('CODE') || '').replace(/`/g,'\\`');
                return `appendHtmlWithBid('${block.id}', \`<pre><code class=\"language-${lang}\">${code}</code></pre>\`);\n`;
            };
            jsGen.forBlock['ui_svg_file'] = function(block, generator){
                const file = block.getFieldValue('FILENAME') || '';
                const safe = file.replace(/`/g, '\\`').replace(/"/g, '&quot;');
                return `appendHtmlWithBid('${block.id}', \`<img src=\"/uploads/${safe}\" alt=\"svg\" style=\"max-width:100%\"/>\`);\n`;
            };
            jsGen.forBlock['ui_xml_file'] = function(block, generator){
                const file = block.getFieldValue('FILENAME') || '';
                const height = block.getFieldValue('HEIGHT') || '400';
                const safe = file.replace(/`/g, '\\`').replace(/"/g, '&quot;');
                const h = height.replace(/[^0-9]/g, '') || '400';
                return `appendHtmlWithBid('${block.id}', \`<object type=\"text/xml\" data=\"/uploads/${safe}\" style=\"width:100%;height:${h}px;border:1px solid #ddd\"></object>\`);\n`;
            };
        } else {
            Blockly.JavaScript['ui_code'] = function(block) {
                const lang = block.getFieldValue('LANG') || 'plaintext';
                const code = (block.getFieldValue('CODE') || '').replace(/`/g,'\\`');
                return `appendHtmlWithBid('${block.id}', \`<pre><code class=\"language-${lang}\">${code}</code></pre>\`);\n`;
            };
            Blockly.JavaScript['ui_svg_file'] = function(block){
                const file = block.getFieldValue('FILENAME') || '';
                const safe = file.replace(/`/g, '\\`').replace(/"/g, '&quot;');
                return `appendHtmlWithBid('${block.id}', \`<img src=\"/uploads/${safe}\" alt=\"svg\" style=\"max-width:100%\"/>\`);\n`;
            };
            Blockly.JavaScript['ui_xml_file'] = function(block){
                const file = block.getFieldValue('FILENAME') || '';
                const height = block.getFieldValue('HEIGHT') || '400';
                const safe = file.replace(/`/g, '\\`').replace(/"/g, '&quot;');
                const h = height.replace(/[^0-9]/g, '') || '400';
                return `appendHtmlWithBid('${block.id}', \`<object type=\"text/xml\" data=\"/uploads/${safe}\" style=\"width:100%;height:${h}px;border:1px solid #ddd\"></object>\`);\n`;
            };
        }

        // JSON Helper Blocks
        Blockly.Blocks['json_object'] = {
            init: function() {
                this.appendDummyInput().appendField("JSON object");
                this.appendStatementInput("PROPERTIES").appendField("properties:");
                this.setOutput(true, "String");
                this.setColour(160);
            }
        };

        Blockly.Blocks['json_property'] = {
            init: function() {
                this.appendValueInput("KEY").appendField("key:").setCheck("String");
                this.appendValueInput("VALUE").appendField("value:").setCheck(["String", "Number"]);
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(160);
            }
        };

        Blockly.Blocks['json_array'] = {
            init: function() {
                this.appendDummyInput().appendField("JSON array");
                this.appendStatementInput("ITEMS").appendField("items:");
                this.setOutput(true, "String");
                this.setColour(160);
            }
        };

        // JavaScript generators for JSON blocks - Fixed version (use global jsGen alias)
        
        // JSON Object block generator
        const jsonObjectGenerator = function(block, generator) {
            const gen = generator || Blockly.JavaScript;
            const properties = gen.statementToCode(block, 'PROPERTIES');
            return [`JSON.stringify({${properties.replace(/,\s*$/, '')}})`, (gen.ORDER_FUNCTION_CALL || Blockly.JavaScript.ORDER_FUNCTION_CALL)];
        };
        
        // JSON Property block generator
        const jsonPropertyGenerator = function(block, generator) {
            const gen = generator || Blockly.JavaScript;
            const order = gen.ORDER_NONE || Blockly.JavaScript.ORDER_NONE;
            const key = gen.valueToCode(block, 'KEY', order) || '""';
            const value = gen.valueToCode(block, 'VALUE', order) || '""';
            return `${key}: ${value},\n`;
        };
        
        // JSON Array block generator 
        const jsonArrayGenerator = function(block, generator) {
            const gen = generator || Blockly.JavaScript;
            const items = gen.statementToCode(block, 'ITEMS');
            return [`JSON.stringify([${items.replace(/,\s*$/, '')}])`, (gen.ORDER_FUNCTION_CALL || Blockly.JavaScript.ORDER_FUNCTION_CALL)];
        };

        // Register generators using both methods for compatibility
        if (jsGen && jsGen.forBlock) {
            jsGen.forBlock['json_object'] = jsonObjectGenerator;
            jsGen.forBlock['json_property'] = jsonPropertyGenerator;
            jsGen.forBlock['json_array'] = jsonArrayGenerator;
        }
        
        // Legacy registration as fallback
        Blockly.JavaScript['json_object'] = jsonObjectGenerator;
        Blockly.JavaScript['json_property'] = jsonPropertyGenerator;
        Blockly.JavaScript['json_array'] = jsonArrayGenerator;

        return true;
    }

    // Start: generuj bloki z OpenAPI i skryptów, potem uruchom runCode
    async function initializeBlocks() {
        // Define base blocks first
        if (!defineBaseBlocks()) {
            console.error("Failed to define base blocks");
            return;
        }
        await generateApiBlocks();
        await loadScripts();

        // Temporarily disable automatic code generation to stop error spam
        console.log("Initialization complete. Auto-generation enabled.");
        // Load existing project list into dropdown
        try { await refreshProjectList(); } catch(e) { console.warn('Project list load failed on init', e); }
        try { await refreshDemoList(); } catch(e) { console.warn('Demo list load failed on init', e); }
        try { await refreshUploads(); } catch(e) { console.warn('Uploads list load failed on init', e); }
        // Set default project name to current date-time if empty
        try { setDefaultProjectNameTimestamp(true); } catch(e){}
        // Auto-run once on init
        runCodeDebounced();

        // (removed test page injection to keep auto preview)
    }

    

    // ---- Ładowanie bloków ze skryptów ----
    async function loadScripts() {
      try {
        const res = await fetch("/scripts.json");
        const scripts = await res.json();
        const scriptsCat = document.getElementById("scriptsCategory");

        scripts.forEach(scr => {
          const blockName = `form_${scr.func}_${scr.script.replace(/\W/g,"_")}`;
          const blockEl = document.createElement("block");
          blockEl.setAttribute("type", blockName);
          scriptsCat.appendChild(blockEl);

          Blockly.Blocks[blockName] = {
            init: function() {
              this.appendDummyInput().appendField("Formularz do " + scr.script + " → " + scr.func);
              this.setPreviousStatement(true, null);
              this.setNextStatement(true, null);
              this.setColour(290);
            }
          };

          // Kod JS z bloku (typed generator API with legacy fallback)
          const formJS = Blockly.JavaScript;
          if (formJS && formJS.forBlock) {
            formJS.forBlock[blockName] = function(block, generator) {
              // Generowanie formularza HTML
              let formId = `form_${scr.script}_${scr.func}`.replace(/\W/g,"_");
              let inputs = scr.params.map(p => `<label>${p}: <input name="${p}"></label><br>`).join("");
              let html = `
        htmlOutput += \`
          <form id="${formId}">
            <h3>${scr.script} → ${scr.func}</h3>
            ${inputs}
            <button type="button" onclick="run_${formId}()">Uruchom</button>
            <pre id="${formId}_output"></pre>
          </form>\`;
      `;

              // JS do obsługi formularza
              let jsHandler = `
        window.run_${formId} = function(){
          const form = document.getElementById("${formId}");
          let data = {};
          ${scr.params.map(p => `data["${p}"] = form.querySelector('[name="${p}"]').value;`).join("\n          ")}
          fetch("/run-script",{method:"POST",headers:{'Content-Type':'application/json'},
            body:JSON.stringify({script:"${scr.script}",func:"${scr.func}",args:Object.values(data)})})
            .then(r=>r.json())
            .then(res=>{
              document.querySelector('#app #${formId}_output').innerText =
                "stdout:\\n"+res.stdout+"\\n---\\nstderr:\\n"+res.stderr;
            })
            .catch(err=>{
              document.querySelector('#app #${formId}_output').innerText =
                "error:\\n"+err.message;
            });
        }
      `;
              return html + jsHandler;
            };
          } else {
            Blockly.JavaScript[blockName] = function() {
              // Generowanie formularza HTML
              let formId = `form_${scr.script}_${scr.func}`.replace(/\W/g,"_");
              let inputs = scr.params.map(p => `<label>${p}: <input name="${p}"></label><br>`).join("");
              let html = `
        htmlOutput += \`
          <form id="${formId}">
            <h3>${scr.script} → ${scr.func}</h3>
            ${inputs}
            <button type="button" onclick="run_${formId}()">Uruchom</button>
            <pre id="${formId}_output"></pre>
          </form>\`;
      `;

              // JS do obsługi formularza
              let jsHandler = `
        window.run_${formId} = function(){
          const form = document.getElementById("${formId}");
          let data = {};
          ${scr.params.map(p => `data["${p}"] = form.querySelector('[name="${p}"]').value;`).join("\n          ")}
          fetch("/run-script",{method:"POST",headers:{'Content-Type':'application/json'},
            body:JSON.stringify({script:"${scr.script}",func:"${scr.func}",args:Object.values(data)})})
            .then(r=>r.json())
            .then(res=>{
              document.querySelector('#app #${formId}_output').innerText =
                "stdout:\\n"+res.stdout+"\\n---\\nstderr:\\n"+res.stderr;
            })
            .catch(err=>{
              document.querySelector('#app #${formId}_output').innerText =
                "error:\\n"+err.message;
            });
        }
      `;
              return html + jsHandler;
            };
          }
        });
      } catch (e) {
        console.error("Failed to load scripts", e);
      }
    }

    // Initialize all blocks and start the application
    initializeBlocks();
</script>
</body>
</html>
