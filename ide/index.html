<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
</head>
<body>
<h2>IDE z OpenAPI → automatyczne bloki</h2>
<div id="blocklyDiv" style="height: 500px; width: 50%; float:left;"></div>
<iframe id="preview" style="height: 500px; width: 50%; float:left; border:1px solid #ccc;"></iframe>

<xml id="toolbox" style="display:none">
    <category name="UI" colour="120">
        <block type="add_view"></block>
    </category>
    <category id="apiCategory" name="API" colour="230"></category>
    <category id="scriptsCategory" name="Scripts" colour="290"></category>
</xml>

<script>
    const workspace = Blockly.inject('blocklyDiv', { toolbox: document.getElementById('toolbox') });

    // Block definitions will be handled in initializeBlocks()

    // --- Funkcja: Generowanie bloków API z OpenAPI ---
    async function generateApiBlocks() {
        const spec = await loadOpenAPI("https://petstore.swagger.io/v2/swagger.json");
        const apiCategory = document.getElementById("apiCategory");

        Object.entries(spec.paths).forEach(([path, methods]) => {
            Object.entries(methods).forEach(([method, details]) => {
                const blockName = `api_${method}_${path.replace(/[\/{}]/g, "_")}`;
                const summary = details.summary || `${method.toUpperCase()} ${path}`;

                // Dodaj blok do toolbox
                const blockEl = document.createElement("block");
                blockEl.setAttribute("type", blockName);
                apiCategory.appendChild(blockEl);

                // Definicja bloku
                Blockly.Blocks[blockName] = {
                    init: function() {
                        this.appendDummyInput().appendField(summary);
                        this.setPreviousStatement(true, null);
                        this.setNextStatement(true, null);
                        this.setColour(230);
                    }
                };

                // Kod JS z bloku (typed generator API with legacy fallback)
                const jsGen = Blockly.JavaScript;
                if (jsGen && jsGen.forBlock) {
                    jsGen.forBlock[blockName] = function(block, generator) {
                        return `
              htmlOutput += '<pre id="${blockName}">Ładowanie...</pre>';
              fetch("${spec.schemes?.[0] || "https"}://${spec.host}${spec.basePath}${path}")
                .then(r => r.json())
                .then(data => {
                  document.getElementById("${blockName}").innerText = JSON.stringify(data,null,2);
                });
            `;
                    };
                } else {
                    Blockly.JavaScript[blockName] = function() {
                        return `
              htmlOutput += '<pre id="${blockName}">Ładowanie...</pre>';
              fetch("${spec.schemes?.[0] || "https"}://${spec.host}${spec.basePath}${path}")
                .then(r => r.json())
                .then(data => {
                  document.getElementById("${blockName}").innerText = JSON.stringify(data,null,2);
                });
            `;
                    };
                }
            });
        });
    }

    async function loadOpenAPI(url) {
        const res = await fetch(url);
        return res.json();
    }

    // --- Generowanie wynikowego HTML ---
    function runCode() {
        try {
            // Ensure generators are registered right before code generation
            console.log("Ensuring generators are registered...");
            
            // Re-register add_view generator to ensure it's available (typed generator API with legacy fallback)
            const jsGen = Blockly.JavaScript;
            if (jsGen && jsGen.forBlock) {
                jsGen.forBlock['add_view'] = function(block, generator) {
                    const name = block.getFieldValue('VIEW');
                    const content = generator.statementToCode(block, 'CONTENT');
                    return `views.push({name:"${name}", html:\`${content}\`});\n`;
                };
            } else {
                Blockly.JavaScript['add_view'] = function(block) {
                    const name = block.getFieldValue('VIEW');
                    const content = Blockly.JavaScript.statementToCode(block, 'CONTENT');
                    return `views.push({name:"${name}", html:\`${content}\`});\n`;
                };
            }
            
            console.log("add_view generator (forBlock):", jsGen && jsGen.forBlock ? typeof jsGen.forBlock['add_view'] : 'no forBlock');
            console.log("add_view generator (legacy):", typeof Blockly.JavaScript['add_view']);
            
            let code = "";
            try {
                code = Blockly.JavaScript.workspaceToCode(workspace);
            } catch (e) {
                console.error("Error generating code from workspace:", e);
                // Show error in preview
                document.getElementById('preview').srcdoc = `
                    <html><body>
                        <h3>Error generating code:</h3>
                        <pre>${e.message}</pre>
                        <p>Please check that all blocks have proper generators defined.</p>
                    </body></html>
                `;
                return;
            }
            
            // Create a complete HTML document structure for the iframe
            let iframeContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
</head>
<body>
    <div id="app"></div>
    <script>
        let views = [];
        let htmlOutput = "";
        ${code}
        let finalHTML = "";
        views.forEach(v=>{
          finalHTML += '<section id="'+v.name+'">'+v.html+'</section>';
        });
        finalHTML += htmlOutput;
        document.getElementById('app').innerHTML = finalHTML;
    <\/script>
</body>
</html>
`;
            document.getElementById('preview').srcdoc = iframeContent;
        } catch (e) {
            console.error("Error in runCode:", e);
        }
    }

    // Define all blocks in initialization function to ensure proper timing
    function defineBaseBlocks() {
        // --- Prosty blok UI (widok) ---
        Blockly.Blocks['add_view'] = {
            init: function() {
                this.appendDummyInput().appendField("Dodaj widok").appendField(new Blockly.FieldTextInput("Widok"), "VIEW");
                this.appendStatementInput("CONTENT").setCheck(null).appendField("zawiera");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(120);
            }
        };
        
        // Ensure JavaScript generator is properly defined
        if (!Blockly.JavaScript) {
            console.error("Blockly.JavaScript is not available!");
            return false;
        }
        
        const jsGen = Blockly.JavaScript;
        if (jsGen.forBlock) {
            jsGen.forBlock['add_view'] = function(block, generator) {
                const name = block.getFieldValue('VIEW');
                const content = generator.statementToCode(block, 'CONTENT');
                return `views.push({name:"${name}", html:\`${content}\`});\n`;
            };
        } else {
            Blockly.JavaScript['add_view'] = function(block) {
                const name = block.getFieldValue('VIEW');
                const content = Blockly.JavaScript.statementToCode(block, 'CONTENT');
                return `views.push({name:"${name}", html:\`${content}\`});\n`;
            };
        }
        
        // Verify the generator was registered
        console.log("add_view generator registered (forBlock):", jsGen.forBlock ? typeof jsGen.forBlock['add_view'] : 'no forBlock');
        console.log("add_view generator registered (legacy):", typeof Blockly.JavaScript['add_view']);
        return true;
    }

    // Test function to verify Blockly generator registration
    function testGeneratorRegistration() {
        console.log("=== BLOCKLY GENERATOR TEST ===");
        console.log("Blockly object:", typeof Blockly);
        console.log("Blockly.JavaScript object:", typeof Blockly.JavaScript);
        
        // Test simple generator registration (typed API with fallback)
        const jsGen = Blockly.JavaScript;
        if (jsGen.forBlock) {
            jsGen.forBlock['test_block'] = function(block, generator) {
                return 'console.log("test");\n';
            };
        } else {
            Blockly.JavaScript['test_block'] = function(block) {
                return 'console.log("test");\n';
            };
        }
        
        console.log("test_block (forBlock):", jsGen.forBlock ? typeof jsGen.forBlock['test_block'] : 'no forBlock');
        console.log("add_view (forBlock):", jsGen.forBlock ? typeof jsGen.forBlock['add_view'] : 'no forBlock');
        console.log("test_block (legacy):", typeof Blockly.JavaScript['test_block']);
        console.log("add_view (legacy):", typeof Blockly.JavaScript['add_view']);
    }

    // Start: generuj bloki z OpenAPI i skryptów, potem uruchom runCode
    async function initializeBlocks() {
        // Define base blocks first
        if (!defineBaseBlocks()) {
            console.error("Failed to define base blocks");
            return;
        }
        
        // Test generator registration
        testGeneratorRegistration();
        
        await generateApiBlocks();
        await loadScripts();
        
        // Temporarily disable automatic code generation to stop error spam
        console.log("Initialization complete. Auto-generation disabled for testing.");
        
        // Add manual test button to preview
        document.getElementById('preview').srcdoc = `
            <html>
            <body>
                <h3>Blockly Generator Test</h3>
                <button onclick="parent.testCodeGeneration()">Test Code Generation</button>
                <pre id="output">Click the button to test code generation manually.</pre>
            </body>
            </html>
        `;
    }
    
    // Manual test function
    window.testCodeGeneration = function() {
        console.log("=== MANUAL CODE GENERATION TEST ===");
        testGeneratorRegistration();
        
        try {
            let code = Blockly.JavaScript.workspaceToCode(workspace);
            console.log("Generated code:", code);
            document.getElementById('preview').contentDocument.getElementById('output').textContent = 
                "Success! Generated code:\n" + code;
        } catch (e) {
            console.error("Code generation failed:", e);
            document.getElementById('preview').contentDocument.getElementById('output').textContent = 
                "Error: " + e.message;
        }
    };
    
    // ---- Ładowanie bloków ze skryptów ----
    async function loadScripts() {
      try {
        const res = await fetch("/scripts.json");
        const scripts = await res.json();
        const scriptsCat = document.getElementById("scriptsCategory");

        scripts.forEach(scr => {
          const blockName = `form_${scr.func}_${scr.script.replace(/\W/g,"_")}`;
          const blockEl = document.createElement("block");
          blockEl.setAttribute("type", blockName);
          scriptsCat.appendChild(blockEl);

          Blockly.Blocks[blockName] = {
            init: function() {
              this.appendDummyInput().appendField("Formularz do " + scr.script + " → " + scr.func);
              this.setPreviousStatement(true, null);
              this.setNextStatement(true, null);
              this.setColour(290);
            }
          };

          // Kod JS z bloku (typed generator API with legacy fallback)
          const jsGen = Blockly.JavaScript;
          if (jsGen && jsGen.forBlock) {
            jsGen.forBlock[blockName] = function(block, generator) {
              // Generowanie formularza HTML
              let formId = `form_${scr.script}_${scr.func}`.replace(/\W/g,"_");
              let inputs = scr.params.map(p => `<label>${p}: <input name="${p}"></label><br>`).join("");
              let html = `
        htmlOutput += \`
          <form id="${formId}">
            <h3>${scr.script} → ${scr.func}</h3>
            ${inputs}
            <button type="button" onclick="run_${formId}()">Uruchom</button>
            <pre id="${formId}_output"></pre>
          </form>\`;
      `;

              // JS do obsługi formularza
              let jsHandler = `
        window.run_${formId} = function(){
          const form = document.getElementById("${formId}");
          let data = {};
          ${scr.params.map(p => `data["${p}"] = form.querySelector('[name="${p}"]').value;`).join("\n          ")}
          fetch("/run-script",{method:"POST",headers:{'Content-Type':'application/json'},
            body:JSON.stringify({script:"${scr.script}",func:"${scr.func}",args:Object.values(data)})})
            .then(r=>r.json())
            .then(res=>{
              document.querySelector('#app #${formId}_output').innerText = 
                "stdout:\\n"+res.stdout+"\\n---\\nstderr:\\n"+res.stderr;
            })
            .catch(err=>{
              document.querySelector('#app #${formId}_output').innerText = 
                "error:\\n"+err.message;
            });
        }
      `;
              return html + jsHandler;
            };
          } else {
            Blockly.JavaScript[blockName] = function() {
              // Generowanie formularza HTML
              let formId = `form_${scr.script}_${scr.func}`.replace(/\W/g,"_");
              let inputs = scr.params.map(p => `<label>${p}: <input name="${p}"></label><br>`).join("");
              let html = `
        htmlOutput += \`
          <form id="${formId}">
            <h3>${scr.script} → ${scr.func}</h3>
            ${inputs}
            <button type="button" onclick="run_${formId}()">Uruchom</button>
            <pre id="${formId}_output"></pre>
          </form>\`;
      `;

              // JS do obsługi formularza
              let jsHandler = `
        window.run_${formId} = function(){
          const form = document.getElementById("${formId}");
          let data = {};
          ${scr.params.map(p => `data["${p}"] = form.querySelector('[name="${p}"]').value;`).join("\n          ")}
          fetch("/run-script",{method:"POST",headers:{'Content-Type':'application/json'},
            body:JSON.stringify({script:"${scr.script}",func:"${scr.func}",args:Object.values(data)})})
            .then(r=>r.json())
            .then(res=>{
              document.querySelector('#app #${formId}_output').innerText = 
                "stdout:\\n"+res.stdout+"\\n---\\nstderr:\\n"+res.stderr;
            })
            .catch(err=>{
              document.querySelector('#app #${formId}_output').innerText = 
                "error:\\n"+err.message;
            });
        }
      `;
              return html + jsHandler;
            };
          }
        });
      } catch (e) {
        console.error("Failed to load scripts", e);
      }
    }
    
    // Initialize all blocks and start the application
    initializeBlocks();
</script>
</body>
</html>
